#===============================================================================
# Azure DevOps CD Pipeline
# Continuous Deployment for Azure AI/ML Platform
#===============================================================================

trigger: none

resources:
  pipelines:
    - pipeline: CI
      source: '$(PROJECT_NAME)-CI'
      trigger:
        branches:
          include:
            - main

variables:
  - group: Azure-Credentials-$(ENVIRONMENT)
  - group: App-Settings-$(ENVIRONMENT)

stages:
  #-----------------------------------------------------------------------------
  # Stage 1: Deploy to Dev
  #-----------------------------------------------------------------------------
  - stage: DeployDev
    displayName: 'Deploy to Development'
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/develop')
    variables:
      - name: ENVIRONMENT
        value: 'dev'
    jobs:
      - deployment: DeployDevJob
        displayName: 'Deploy to Dev Environment'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'development'
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'dev'
                    azureSubscription: 'Azure-dev'

  #-----------------------------------------------------------------------------
  # Stage 2: Deploy to Staging
  #-----------------------------------------------------------------------------
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: DeployDev
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    variables:
      - name: ENVIRONMENT
        value: 'staging'
    jobs:
      - deployment: DeployStagingJob
        displayName: 'Deploy to Staging Environment'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'staging'
                    azureSubscription: 'Azure-staging'

      - job: IntegrationTests
        displayName: 'Run Integration Tests'
        dependsOn: DeployStagingJob
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.11'

          - script: |
              pip install pytest requests
              pytest tests/integration/ --junitxml=integration-results.xml
            displayName: 'Run integration tests'

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/integration-results.xml'

  #-----------------------------------------------------------------------------
  # Stage 3: Deploy to Production
  #-----------------------------------------------------------------------------
  - stage: DeployProd
    displayName: 'Deploy to Production'
    dependsOn: DeployStaging
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    variables:
      - name: ENVIRONMENT
        value: 'prod'
    jobs:
      - deployment: DeployProdJob
        displayName: 'Deploy to Production Environment'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            preDeploy:
              steps:
                - script: |
                    echo "Running pre-deployment checks..."
                    echo "Verifying health of staging environment..."
                  displayName: 'Pre-deployment validation'
            deploy:
              steps:
                - template: templates/deploy-steps.yml
                  parameters:
                    environment: 'prod'
                    azureSubscription: 'Azure-prod'
            postRouteTraffic:
              steps:
                - script: |
                    echo "Running smoke tests..."
                  displayName: 'Smoke tests'
            on:
              failure:
                steps:
                  - script: |
                      echo "Deployment failed. Initiating rollback..."
                    displayName: 'Rollback notification'
              success:
                steps:
                  - script: |
                      echo "Production deployment successful!"
                    displayName: 'Success notification'
