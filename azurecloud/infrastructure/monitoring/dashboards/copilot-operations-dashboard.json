{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Enterprise Copilot Operations Dashboard"
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "workbook"
    }
  },
  "resources": [
    {
      "type": "microsoft.insights/workbooks",
      "name": "[guid('copilot-operations-dashboard')]",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Enterprise Copilot Operations Dashboard\\n---\\n\\n## Real-time monitoring for RAG pipeline, search, and AI services\"},\"name\":\"header\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"name\":\"TimeRange\",\"type\":4,\"value\":{\"durationMs\":3600000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":604800000}]}}],\"style\":\"pills\"},\"name\":\"parameters\"},{\"type\":1,\"content\":{\"json\":\"## System Health Overview\"},\"name\":\"section-health\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"requests\\n| where timestamp > ago(1h)\\n| summarize \\n    TotalRequests = count(),\\n    SuccessRate = round(100.0 * countif(success == true) / count(), 2),\\n    AvgLatency = round(avg(duration), 0),\\n    P95Latency = round(percentile(duration, 95), 0),\\n    P99Latency = round(percentile(duration, 99), 0)\\n| project \\n    ['Total Requests'] = TotalRequests,\\n    ['Success Rate %'] = SuccessRate,\\n    ['Avg Latency (ms)'] = AvgLatency,\\n    ['P95 Latency (ms)'] = P95Latency,\\n    ['P99 Latency (ms)'] = P99Latency\",\"size\":4,\"title\":\"Key Metrics (Last Hour)\",\"timeContext\":{\"durationMs\":3600000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"tiles\",\"tileSettings\":{\"showBorder\":true,\"titleContent\":{\"columnMatch\":\"Column1\"},\"leftContent\":{\"columnMatch\":\"Value\",\"formatter\":12}}},\"name\":\"kpi-tiles\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let openai_status = customMetrics\\n| where name == 'openai_available'\\n| summarize status = iff(avg(value) > 0.9, 'Healthy', 'Degraded') by Component = 'Azure OpenAI';\\nlet search_status = customMetrics\\n| where name == 'search_available'\\n| summarize status = iff(avg(value) > 0.9, 'Healthy', 'Degraded') by Component = 'AI Search';\\nlet cosmos_status = customMetrics\\n| where name == 'cosmos_available'\\n| summarize status = iff(avg(value) > 0.9, 'Healthy', 'Degraded') by Component = 'Cosmos DB';\\nlet rag_status = requests\\n| where name contains 'rag'\\n| summarize status = iff(countif(success) * 1.0 / count() > 0.95, 'Healthy', 'Degraded') by Component = 'RAG Pipeline';\\nunion openai_status, search_status, cosmos_status, rag_status\",\"size\":1,\"title\":\"Component Health Status\",\"timeContext\":{\"durationMs\":900000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"status\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"colors\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Healthy\",\"representation\":\"green\"},{\"operator\":\"==\",\"thresholdValue\":\"Degraded\",\"representation\":\"yellow\"},{\"operator\":\"Default\",\"representation\":\"red\"}]}}]}},\"name\":\"component-health\"},{\"type\":1,\"content\":{\"json\":\"## Request & Latency Trends\"},\"name\":\"section-requests\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"requests\\n| where timestamp > ago(24h)\\n| summarize \\n    Requests = count(),\\n    Errors = countif(success == false)\\n    by bin(timestamp, 5m)\\n| project timestamp, Requests, Errors\",\"size\":0,\"title\":\"Request Volume (24h)\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"areachart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Requests\",\"color\":\"blue\"},{\"seriesName\":\"Errors\",\"color\":\"red\"}]}},\"name\":\"request-volume\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"requests\\n| where timestamp > ago(24h)\\n| summarize \\n    P50 = percentile(duration, 50),\\n    P95 = percentile(duration, 95),\\n    P99 = percentile(duration, 99)\\n    by bin(timestamp, 5m)\",\"size\":0,\"title\":\"Latency Percentiles (24h)\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"linechart\",\"chartSettings\":{\"yAxis\":[\"P50\",\"P95\",\"P99\"],\"seriesLabelSettings\":[{\"seriesName\":\"P50\",\"color\":\"green\"},{\"seriesName\":\"P95\",\"color\":\"orange\"},{\"seriesName\":\"P99\",\"color\":\"red\"}]}},\"name\":\"latency-percentiles\"},{\"type\":1,\"content\":{\"json\":\"## RAG Pipeline Metrics\"},\"name\":\"section-rag\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"customMetrics\\n| where name in ('embedding_latency', 'search_latency', 'llm_latency')\\n| summarize avg_latency = avg(value) by name, bin(timestamp, 5m)\\n| project timestamp, name, avg_latency\",\"size\":0,\"title\":\"RAG Component Latencies\",\"timeContext\":{\"durationMs\":3600000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"linechart\"},\"name\":\"rag-latencies\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"customMetrics\\n| where name == 'cache_hit_rate'\\n| summarize hit_rate = avg(value) by bin(timestamp, 15m)\\n| project timestamp, ['Cache Hit Rate %'] = hit_rate\",\"size\":0,\"title\":\"Cache Hit Rate\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"linechart\",\"chartSettings\":{\"yAxis\":[\"Cache Hit Rate %\"],\"ySettings\":{\"min\":0,\"max\":100}}},\"name\":\"cache-hit-rate\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"customMetrics\\n| where name == 'retrieval_relevance'\\n| summarize avg_relevance = avg(value) by bin(timestamp, 1h)\\n| project timestamp, ['Retrieval Relevance'] = avg_relevance\",\"size\":0,\"title\":\"Retrieval Relevance Score\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"linechart\"},\"name\":\"retrieval-relevance\"},{\"type\":1,\"content\":{\"json\":\"## Azure OpenAI Metrics\"},\"name\":\"section-openai\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureMetrics\\n| where ResourceProvider == 'MICROSOFT.COGNITIVESERVICES'\\n| where MetricName == 'TokenTransaction'\\n| summarize tokens = sum(Total) by bin(TimeGenerated, 1h), Model = tostring(split(DimensionValue, ',')[0])\\n| project TimeGenerated, Model, tokens\",\"size\":0,\"title\":\"Token Usage by Model\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"name\":\"token-usage\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureMetrics\\n| where ResourceProvider == 'MICROSOFT.COGNITIVESERVICES'\\n| where MetricName == 'SuccessfulCalls' or MetricName == 'RateLimitedCalls'\\n| summarize calls = sum(Total) by MetricName, bin(TimeGenerated, 15m)\\n| project TimeGenerated, MetricName, calls\",\"size\":0,\"title\":\"OpenAI Call Success vs Rate Limited\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"name\":\"openai-calls\"},{\"type\":1,\"content\":{\"json\":\"## AI Search Metrics\"},\"name\":\"section-search\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureMetrics\\n| where ResourceProvider == 'MICROSOFT.SEARCH'\\n| where MetricName == 'SearchQueriesPerSecond'\\n| summarize qps = avg(Average) by bin(TimeGenerated, 5m)\\n| project TimeGenerated, ['Queries/sec'] = qps\",\"size\":0,\"title\":\"Search Queries Per Second\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"name\":\"search-qps\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureMetrics\\n| where ResourceProvider == 'MICROSOFT.SEARCH'\\n| where MetricName == 'SearchLatency'\\n| summarize avg_latency = avg(Average), p95 = percentile(Average, 95) by bin(TimeGenerated, 15m)\\n| project TimeGenerated, ['Avg Latency'] = avg_latency, ['P95 Latency'] = p95\",\"size\":0,\"title\":\"Search Latency\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"name\":\"search-latency\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureMetrics\\n| where ResourceProvider == 'MICROSOFT.SEARCH'\\n| where MetricName == 'DocumentCount'\\n| summarize doc_count = max(Maximum) by bin(TimeGenerated, 1h)\\n| project TimeGenerated, ['Document Count'] = doc_count\",\"size\":0,\"title\":\"Index Document Count\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"linechart\"},\"name\":\"document-count\"},{\"type\":1,\"content\":{\"json\":\"## Error Analysis\"},\"name\":\"section-errors\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"exceptions\\n| where timestamp > ago(24h)\\n| summarize count() by type, outerMessage\\n| order by count_ desc\\n| take 10\",\"size\":0,\"title\":\"Top Exceptions (24h)\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"table\"},\"name\":\"top-exceptions\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"requests\\n| where success == false\\n| where timestamp > ago(24h)\\n| summarize count() by resultCode\\n| order by count_ desc\",\"size\":1,\"title\":\"Error Codes Distribution\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"piechart\"},\"name\":\"error-distribution\"},{\"type\":1,\"content\":{\"json\":\"## Ingestion Pipeline\"},\"name\":\"section-ingestion\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"traces\\n| where operation_Name contains 'ingestion'\\n| where timestamp > ago(24h)\\n| summarize \\n    processed = countif(severityLevel <= 2),\\n    failed = countif(severityLevel >= 3)\\n    by bin(timestamp, 1h)\\n| project timestamp, ['Processed'] = processed, ['Failed'] = failed\",\"size\":0,\"title\":\"Document Ingestion (24h)\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"barchart\"},\"name\":\"ingestion-volume\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"customMetrics\\n| where name == 'documents_ingested'\\n| summarize total = sum(value) by source = tostring(customDimensions.source)\\n| order by total desc\",\"size\":1,\"title\":\"Documents by Source\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"piechart\"},\"name\":\"docs-by-source\"},{\"type\":1,\"content\":{\"json\":\"## User Activity\"},\"name\":\"section-users\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"customEvents\\n| where name == 'user_query'\\n| where timestamp > ago(24h)\\n| summarize queries = count() by bin(timestamp, 1h)\\n| project timestamp, ['User Queries'] = queries\",\"size\":0,\"title\":\"User Queries (24h)\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"linechart\"},\"name\":\"user-queries\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"customEvents\\n| where name == 'user_query'\\n| where timestamp > ago(7d)\\n| summarize queries = dcount(tostring(customDimensions.user_id)) by bin(timestamp, 1d)\\n| project timestamp, ['Unique Users'] = queries\",\"size\":0,\"title\":\"Daily Active Users (7d)\",\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.insights/components\",\"visualization\":\"barchart\"},\"name\":\"daily-users\"}],\"isLocked\":false}",
        "version": "1.0",
        "sourceId": "[resourceGroup().id]",
        "category": "workbook"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId('microsoft.insights/workbooks', guid('copilot-operations-dashboard'))]"
    }
  }
}
