# Architecture Flowcharts
# Enterprise GenAI Knowledge Copilot Platform

**Document Version:** 1.0
**Date:** November 2024

---

## 1. System Context Diagram

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                           SYSTEM CONTEXT DIAGRAM                                  │
│                                                                                  │
│  Shows the system in its environment with external actors and systems            │
└──────────────────────────────────────────────────────────────────────────────────┘


                    ┌─────────────────────────────────────────┐
                    │           EXTERNAL ACTORS               │
                    └─────────────────────────────────────────┘

    ┌──────────────┐        ┌──────────────┐        ┌──────────────┐
    │  Knowledge   │        │  Executive   │        │     IT       │
    │   Worker     │        │    User      │        │Administrator │
    │              │        │              │        │              │
    │  • Search    │        │  • Reports   │        │  • Manage    │
    │  • Ask Q&A   │        │  • Summaries │        │  • Monitor   │
    │  • Upload    │        │  • Insights  │        │  • Configure │
    └──────┬───────┘        └──────┬───────┘        └──────┬───────┘
           │                       │                       │
           │      HTTPS/REST       │                       │
           └───────────────────────┼───────────────────────┘
                                   │
                                   ▼
    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                                                                             │
    │                    ┌───────────────────────────────────┐                   │
    │                    │                                   │                   │
    │                    │      GENAI COPILOT PLATFORM       │                   │
    │                    │                                   │                   │
    │                    │   • Intelligent Document Search   │                   │
    │                    │   • AI-Powered Q&A                │                   │
    │                    │   • Document Processing           │                   │
    │                    │   • Conversation Management       │                   │
    │                    │                                   │                   │
    │                    └───────────────────────────────────┘                   │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
                                   │
           ┌───────────────────────┼───────────────────────┐
           │                       │                       │
           ▼                       ▼                       ▼
    ┌──────────────┐        ┌──────────────┐        ┌──────────────┐
    │   Azure AD   │        │   Azure      │        │  Corporate   │
    │  (Entra ID)  │        │   OpenAI     │        │  Network     │
    │              │        │              │        │              │
    │  • Auth      │        │  • GPT-4o    │        │  • VPN       │
    │  • SSO       │        │  • Embeddings│        │  • ExpressRoute│
    │  • MFA       │        │              │        │              │
    └──────────────┘        └──────────────┘        └──────────────┘

                    ┌─────────────────────────────────────────┐
                    │           EXTERNAL SYSTEMS              │
                    └─────────────────────────────────────────┘
```

---

## 2. Container Diagram

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                            CONTAINER DIAGRAM                                      │
│                                                                                  │
│  Shows the high-level technical building blocks (containers)                     │
└──────────────────────────────────────────────────────────────────────────────────┘

                              ┌───────────────────┐
                              │      USERS        │
                              └─────────┬─────────┘
                                        │
                                        │ HTTPS
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              PRESENTATION TIER                                   │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                        REACT FRONTEND (SPA)                               │ │
│  │                                                                           │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │ │
│  │  │   Chat      │  │   Search    │  │  Document   │  │   Admin     │     │ │
│  │  │   Module    │  │   Module    │  │   Manager   │  │   Panel     │     │ │
│  │  │             │  │             │  │             │  │             │     │ │
│  │  │ TypeScript  │  │ TypeScript  │  │ TypeScript  │  │ TypeScript  │     │ │
│  │  │ React 18    │  │ React 18    │  │ React 18    │  │ React 18    │     │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │ │
│  │                                                                           │ │
│  │  Deployed on: Azure VMs with Nginx / Azure Static Web Apps               │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ REST API (JSON)
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                               APPLICATION TIER                                   │
│                                                                                 │
│  ┌───────────────────────┐  ┌───────────────────────┐                         │
│  │    API GATEWAY        │  │     ORCHESTRATOR      │                         │
│  │    ─────────────      │  │     ────────────      │                         │
│  │                       │  │                       │                         │
│  │  • Request routing    │  │  • Workflow mgmt      │                         │
│  │  • Authentication     │──│  • Context assembly   │                         │
│  │  • Rate limiting      │  │  • Response aggregation                         │
│  │  • Input validation   │  │                       │                         │
│  │                       │  │  Azure Functions      │                         │
│  │  Azure Functions      │  │  (Premium EP1)        │                         │
│  │  (Consumption Y1)     │  │                       │                         │
│  └───────────────────────┘  └───────────────────────┘                         │
│                                        │                                       │
│           ┌────────────────────────────┴────────────────────────────┐         │
│           ▼                                                         ▼         │
│  ┌───────────────────────┐                          ┌───────────────────────┐ │
│  │   INGESTION SERVICE   │                          │    RAG PROCESSOR      │ │
│  │   ─────────────────   │                          │    ─────────────      │ │
│  │                       │                          │                       │ │
│  │  • Document parsing   │                          │  • Query embedding    │ │
│  │  • OCR processing     │                          │  • Hybrid search      │ │
│  │  • Text chunking      │                          │  • Context building   │ │
│  │  • Embedding gen.     │                          │  • LLM generation     │ │
│  │                       │                          │                       │ │
│  │  Azure Functions      │                          │  Azure Functions      │ │
│  │  (Consumption Y1)     │                          │  (Premium EP1)        │ │
│  │  Blob Trigger         │                          │                       │ │
│  └───────────────────────┘                          └───────────────────────┘ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                    ┌───────────────────┴───────────────────┐
                    ▼                                       ▼
┌───────────────────────────────────┐   ┌───────────────────────────────────────┐
│          AI SERVICES              │   │            DATA TIER                  │
│  ┌─────────────────────────────┐ │   │  ┌─────────────────────────────────┐  │
│  │      AZURE OPENAI           │ │   │  │        AZURE AI SEARCH          │  │
│  │      ─────────────          │ │   │  │        ───────────────          │  │
│  │                             │ │   │  │                                 │  │
│  │  • GPT-4o-mini (Chat)       │ │   │  │  • Vector index (1536 dims)     │  │
│  │  • text-embedding-3-small   │ │   │  │  • Hybrid search                │  │
│  │                             │ │   │  │  • Semantic ranking             │  │
│  └─────────────────────────────┘ │   │  └─────────────────────────────────┘  │
│  ┌─────────────────────────────┐ │   │  ┌─────────────────────────────────┐  │
│  │   DOCUMENT INTELLIGENCE     │ │   │  │         COSMOS DB               │  │
│  │   ────────────────────      │ │   │  │         ─────────               │  │
│  │                             │ │   │  │                                 │  │
│  │  • OCR (PDF, images)        │ │   │  │  • Conversations                │  │
│  │  • Form extraction          │ │   │  │  • Document metadata            │  │
│  │  • Layout analysis          │ │   │  │  • User sessions                │  │
│  └─────────────────────────────┘ │   │  │  • Audit logs                   │  │
│  ┌─────────────────────────────┐ │   │  └─────────────────────────────────┘  │
│  │      CONTENT SAFETY         │ │   │  ┌─────────────────────────────────┐  │
│  │      ──────────────         │ │   │  │        BLOB STORAGE             │  │
│  │                             │ │   │  │        ────────────             │  │
│  │  • Input moderation         │ │   │  │                                 │  │
│  │  • Output filtering         │ │   │  │  • Raw documents                │  │
│  └─────────────────────────────┘ │   │  │  • Processed files              │  │
└───────────────────────────────────┘   │  │  • Embeddings cache             │  │
                                        │  └─────────────────────────────────┘  │
                                        └───────────────────────────────────────┘
```

---

## 3. RAG Pipeline Flowchart

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          RAG PIPELINE FLOWCHART                                   │
│                                                                                  │
│  Retrieval-Augmented Generation: Query → Search → Context → Generate            │
└──────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                              USER INPUT PHASE                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

                            ┌────────────────────┐
                            │   User Question    │
                            │                    │
                            │  "What was our Q3  │
                            │   revenue?"        │
                            └─────────┬──────────┘
                                      │
                                      ▼
                            ┌────────────────────┐
                            │  Query Validation  │
                            │  & Preprocessing   │
                            │                    │
                            │  • Sanitize input  │
                            │  • Check length    │
                            │  • Content safety  │
                            └─────────┬──────────┘
                                      │
                                      │ Valid Query
                                      ▼

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            RETRIEVAL PHASE                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

                            ┌────────────────────┐
                            │  Query Embedding   │
                            │                    │
                            │  Azure OpenAI      │
                            │  text-embedding-   │
                            │  3-small           │
                            │                    │
                            │  Output: 1536-dim  │
                            │  vector            │
                            └─────────┬──────────┘
                                      │
                  ┌───────────────────┴───────────────────┐
                  │                                       │
                  ▼                                       ▼
        ┌────────────────────┐              ┌────────────────────┐
        │   Vector Search    │              │   Keyword Search   │
        │                    │              │                    │
        │  Semantic match    │              │  BM25 ranking      │
        │  Cosine similarity │              │  Exact matches     │
        │                    │              │                    │
        │  k=20 results      │              │  k=20 results      │
        └─────────┬──────────┘              └─────────┬──────────┘
                  │                                   │
                  └───────────────┬───────────────────┘
                                  │
                                  ▼
                        ┌────────────────────┐
                        │   Reciprocal Rank  │
                        │   Fusion (RRF)     │
                        │                    │
                        │  Combine & re-rank │
                        │  both result sets  │
                        │                    │
                        │  Output: Top-K     │
                        │  ranked chunks     │
                        └─────────┬──────────┘
                                  │
                                  ▼

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           AUGMENTATION PHASE                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

                        ┌────────────────────┐
                        │  Context Building  │
                        │                    │
                        │  • Select top-5    │
                        │    relevant chunks │
                        │  • Preserve source │
                        │    metadata        │
                        │  • Token counting  │
                        │    (max 8000)      │
                        └─────────┬──────────┘
                                  │
                                  ▼
                        ┌────────────────────┐
                        │  Prompt Assembly   │
                        │                    │
                        │  System Prompt +   │
                        │  Context Docs +    │
                        │  User Query +      │
                        │  Instructions      │
                        └─────────┬──────────┘
                                  │
                                  ▼

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           GENERATION PHASE                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

                        ┌────────────────────┐
                        │   LLM Generation   │
                        │                    │
                        │  Azure OpenAI      │
                        │  GPT-4o-mini       │
                        │                    │
                        │  Temperature: 0.7  │
                        │  Max tokens: 4096  │
                        └─────────┬──────────┘
                                  │
                                  ▼
                        ┌────────────────────┐
                        │ Response Processing│
                        │                    │
                        │  • Extract citations│
                        │  • Validate sources │
                        │  • Format output   │
                        │  • Content safety  │
                        └─────────┬──────────┘
                                  │
                                  ▼
                        ┌────────────────────┐
                        │   Final Response   │
                        │                    │
                        │  "Based on the Q3  │
                        │   Financial Report,│
                        │   revenue was      │
                        │   $45.2M..."       │
                        │                    │
                        │  [Source: Q3       │
                        │   Report, page 5]  │
                        └────────────────────┘
```

---

## 4. Document Ingestion Pipeline

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                      DOCUMENT INGESTION PIPELINE                                  │
└──────────────────────────────────────────────────────────────────────────────────┘

     ┌───────────────────────────────────────────────────────────────────────────┐
     │                           UPLOAD PHASE                                    │
     └───────────────────────────────────────────────────────────────────────────┘

              ┌──────────────┐
              │    User      │
              │   Upload     │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐         ┌──────────────┐
              │   Validate   │   NO    │   Return     │
              │   File       │────────▶│   Error      │
              │              │         │   400        │
              │  • Type?     │         └──────────────┘
              │  • Size?     │
              │  • Virus?    │
              └──────┬───────┘
                     │ YES
                     ▼
              ┌──────────────┐
              │  Upload to   │
              │  Blob Storage│
              │              │
              │  Container:  │
              │  /documents  │
              └──────┬───────┘
                     │
                     │ Blob Trigger
                     ▼
     ┌───────────────────────────────────────────────────────────────────────────┐
     │                         PROCESSING PHASE                                  │
     └───────────────────────────────────────────────────────────────────────────┘

              ┌──────────────┐
              │  Ingestion   │
              │  Function    │
              │  Triggered   │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐
              │  Determine   │
              │  File Type   │
              └──────┬───────┘
                     │
         ┌──────────┼──────────┬──────────┬──────────┐
         ▼          ▼          ▼          ▼          ▼
    ┌─────────┐┌─────────┐┌─────────┐┌─────────┐┌─────────┐
    │  PDF    ││  DOCX   ││  XLSX   ││  PPTX   ││  TXT    │
    │         ││         ││         ││         ││  MD     │
    └────┬────┘└────┬────┘└────┬────┘└────┬────┘└────┬────┘
         │          │          │          │          │
         ▼          ▼          ▼          ▼          ▼
    ┌─────────┐┌─────────┐┌─────────┐┌─────────┐┌─────────┐
    │Document ││python-  ││openpyxl ││python-  ││ Direct  │
    │Intel.   ││docx     ││         ││pptx     ││ Read    │
    │OCR      ││+ OCR    ││         ││+ OCR    ││         │
    └────┬────┘└────┬────┘└────┬────┘└────┬────┘└────┬────┘
         │          │          │          │          │
         └──────────┴──────────┴──────────┴──────────┘
                              │
                              ▼
                       ┌──────────────┐
                       │  Extracted   │
                       │  Raw Text    │
                       │              │
                       │  + Metadata: │
                       │  • Page #    │
                       │  • Section   │
                       │  • Tables    │
                       └──────┬───────┘
                              │
     ┌───────────────────────────────────────────────────────────────────────────┐
     │                          CHUNKING PHASE                                   │
     └───────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                       ┌──────────────┐
                       │   Text       │
                       │   Chunking   │
                       │              │
                       │  Strategy:   │
                       │  • Semantic  │
                       │  • 512 tokens│
                       │  • 50 overlap│
                       └──────┬───────┘
                              │
                              ▼
                       ┌──────────────┐
                       │   Chunks     │
                       │   Created    │
                       │              │
                       │  Chunk 1     │
                       │  Chunk 2     │
                       │  Chunk 3     │
                       │  ...         │
                       │  Chunk N     │
                       └──────┬───────┘
                              │
     ┌───────────────────────────────────────────────────────────────────────────┐
     │                         EMBEDDING PHASE                                   │
     └───────────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                       ┌──────────────┐
                       │  For Each    │◀──────────────────┐
                       │  Chunk       │                   │
                       └──────┬───────┘                   │
                              │                           │
                              ▼                           │
                       ┌──────────────┐                   │
                       │  Generate    │                   │
                       │  Embedding   │                   │
                       │              │                   │
                       │  OpenAI      │                   │
                       │  text-embed- │                   │
                       │  ding-3-small│                   │
                       │              │                   │
                       │  1536 dims   │                   │
                       └──────┬───────┘                   │
                              │                           │
                              ▼                           │
                       ┌──────────────┐        ┌──────────┴───┐
                       │  More        │  YES   │  Next        │
                       │  Chunks?     │───────▶│  Chunk       │
                       └──────┬───────┘        └──────────────┘
                              │ NO
                              ▼
     ┌───────────────────────────────────────────────────────────────────────────┐
     │                          INDEXING PHASE                                   │
     └───────────────────────────────────────────────────────────────────────────┘
                              │
           ┌──────────────────┴──────────────────┐
           ▼                                     ▼
    ┌──────────────┐                      ┌──────────────┐
    │  Index in    │                      │  Store       │
    │  AI Search   │                      │  Metadata    │
    │              │                      │  in Cosmos   │
    │  • Content   │                      │              │
    │  • Vector    │                      │  • Doc ID    │
    │  • Metadata  │                      │  • Title     │
    │              │                      │  • Status    │
    └──────────────┘                      └──────────────┘
           │                                     │
           └──────────────────┬──────────────────┘
                              │
                              ▼
                       ┌──────────────┐
                       │  Update      │
                       │  Status:     │
                       │  "indexed"   │
                       └──────┬───────┘
                              │
                              ▼
                       ┌──────────────┐
                       │  Notify      │
                       │  User        │
                       │              │
                       │  "Document   │
                       │   ready"     │
                       └──────────────┘
```

---

## 5. Authentication Flow

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                         AUTHENTICATION FLOW                                       │
│                                                                                  │
│  OAuth 2.0 Authorization Code Flow with PKCE                                     │
└──────────────────────────────────────────────────────────────────────────────────┘


┌────────┐        ┌────────┐        ┌────────┐        ┌────────┐        ┌────────┐
│  User  │        │Frontend│        │Azure AD│        │  API   │        │ Backend│
│Browser │        │  SPA   │        │Entra ID│        │Gateway │        │Services│
└───┬────┘        └───┬────┘        └───┬────┘        └───┬────┘        └───┬────┘
    │                 │                 │                 │                 │
    │ 1. Access App   │                 │                 │                 │
    │────────────────▶│                 │                 │                 │
    │                 │                 │                 │                 │
    │                 │ 2. Check Token  │                 │                 │
    │                 │ (localStorage)  │                 │                 │
    │                 │─────────────────│                 │                 │
    │                 │                 │                 │                 │
    │                 │ No valid token  │                 │                 │
    │                 │◀─ ─ ─ ─ ─ ─ ─ ─│                 │                 │
    │                 │                 │                 │                 │
    │ 3. Redirect to Azure AD           │                 │                 │
    │◀────────────────│                 │                 │                 │
    │                 │                 │                 │                 │
    │ 4. Login Request (PKCE)           │                 │                 │
    │──────────────────────────────────▶│                 │                 │
    │                 │                 │                 │                 │
    │                 │    ┌────────────┴────────────┐    │                 │
    │                 │    │  Azure AD Login Page   │    │                 │
    │                 │    │  • Username/Password   │    │                 │
    │                 │    │  • MFA Challenge       │    │                 │
    │                 │    │  • Consent Screen      │    │                 │
    │                 │    └────────────┬────────────┘    │                 │
    │                 │                 │                 │                 │
    │ 5. User Authenticates             │                 │                 │
    │──────────────────────────────────▶│                 │                 │
    │                 │                 │                 │                 │
    │ 6. Authorization Code             │                 │                 │
    │   (Redirect to /callback)         │                 │                 │
    │◀──────────────────────────────────│                 │                 │
    │                 │                 │                 │                 │
    │ 7. Auth Code to SPA               │                 │                 │
    │────────────────▶│                 │                 │                 │
    │                 │                 │                 │                 │
    │                 │ 8. Exchange Code for Tokens       │                 │
    │                 │ (with PKCE verifier)              │                 │
    │                 │────────────────▶│                 │                 │
    │                 │                 │                 │                 │
    │                 │ 9. ID Token + Access Token        │                 │
    │                 │◀────────────────│                 │                 │
    │                 │                 │                 │                 │
    │                 │ 10. Store Tokens│                 │                 │
    │                 │ (localStorage)  │                 │                 │
    │                 │─────────────────│                 │                 │
    │                 │                 │                 │                 │
    │ 11. Show App    │                 │                 │                 │
    │◀────────────────│                 │                 │                 │
    │                 │                 │                 │                 │
    │─────────────────────────────────────────────────────────────────────────────│
    │                      SUBSEQUENT API CALLS                                   │
    │─────────────────────────────────────────────────────────────────────────────│
    │                 │                 │                 │                 │
    │ 12. User Action │                 │                 │                 │
    │────────────────▶│                 │                 │                 │
    │                 │                 │                 │                 │
    │                 │ 13. API Request │                 │                 │
    │                 │ Authorization: Bearer {token}     │                 │
    │                 │──────────────────────────────────▶│                 │
    │                 │                 │                 │                 │
    │                 │                 │ 14. Validate JWT│                 │
    │                 │                 │◀────────────────│                 │
    │                 │                 │                 │                 │
    │                 │                 │ 15. Token Valid │                 │
    │                 │                 │────────────────▶│                 │
    │                 │                 │                 │                 │
    │                 │                 │                 │ 16. Process     │
    │                 │                 │                 │────────────────▶│
    │                 │                 │                 │                 │
    │                 │                 │                 │ 17. Response    │
    │                 │                 │                 │◀────────────────│
    │                 │                 │                 │                 │
    │                 │ 18. API Response│                 │                 │
    │                 │◀──────────────────────────────────│                 │
    │                 │                 │                 │                 │
    │ 19. Update UI   │                 │                 │                 │
    │◀────────────────│                 │                 │                 │
    │                 │                 │                 │                 │
```

---

## 6. Network Architecture

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          NETWORK ARCHITECTURE                                     │
│                                                                                  │
│  Azure Virtual Network with Private Endpoints                                    │
└──────────────────────────────────────────────────────────────────────────────────┘


                                    INTERNET
                                        │
                                        │
                            ┌───────────┴───────────┐
                            │    Azure Bastion      │
                            │    (Admin Access)     │
                            │                       │
                            │    pip-bastion-xxx    │
                            └───────────┬───────────┘
                                        │
    ┌───────────────────────────────────────────────────────────────────────────┐
    │                                                                           │
    │                    AZURE VIRTUAL NETWORK                                  │
    │                    vnet-genai-copilot-dev                                 │
    │                    10.0.0.0/16                                            │
    │                                                                           │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  AzureBastionSubnet                                                 │ │
    │  │  10.0.254.0/27                                                      │ │
    │  │                                                                     │ │
    │  │  ┌─────────────────────────────────────────────────────────────┐   │ │
    │  │  │              Azure Bastion Host                             │   │ │
    │  │  │              bastion-genai-copilot                          │   │ │
    │  │  └─────────────────────────────────────────────────────────────┘   │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                    │                                      │
    │                                    │ RDP/SSH over HTTPS                   │
    │                                    ▼                                      │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  snet-vm                                                            │ │
    │  │  10.0.3.0/24                                                        │ │
    │  │  NSG: nsg-vm (SSH from Bastion only)                                │ │
    │  │                                                                     │ │
    │  │  ┌──────────────────┐                                               │ │
    │  │  │   vm-backend-1   │  Linux VM (Ubuntu 22.04)                      │ │
    │  │  │   10.0.3.4       │  • Python backend                             │ │
    │  │  │                  │  • Nginx (frontend hosting)                   │ │
    │  │  └──────────────────┘                                               │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                    │                                      │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  snet-functions                                                     │ │
    │  │  10.0.2.0/24                                                        │ │
    │  │  NSG: nsg-functions                                                 │ │
    │  │  Delegated to: Microsoft.Web/serverFarms                            │ │
    │  │                                                                     │ │
    │  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │ │
    │  │  │ func-api         │  │ func-orch        │  │ func-rag         │  │ │
    │  │  │ (VNet Integrated)│  │ (VNet Integrated)│  │ (VNet Integrated)│  │ │
    │  │  └──────────────────┘  └──────────────────┘  └──────────────────┘  │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                    │                                      │
    │                                    │ Private Endpoints                    │
    │                                    ▼                                      │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  snet-private-endpoints                                             │ │
    │  │  10.0.1.0/24                                                        │ │
    │  │                                                                     │ │
    │  │  ┌─────────────────────────────────────────────────────────────┐   │ │
    │  │  │                  PRIVATE ENDPOINTS                          │   │ │
    │  │  │                                                             │   │ │
    │  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐              │   │ │
    │  │  │  │pe-openai  │  │pe-search  │  │pe-cosmos  │              │   │ │
    │  │  │  │10.0.1.4   │  │10.0.1.5   │  │10.0.1.6   │              │   │ │
    │  │  │  └───────────┘  └───────────┘  └───────────┘              │   │ │
    │  │  │                                                             │   │ │
    │  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐              │   │ │
    │  │  │  │pe-storage │  │pe-keyvault│  │pe-docint  │              │   │ │
    │  │  │  │10.0.1.7   │  │10.0.1.8   │  │10.0.1.9   │              │   │ │
    │  │  │  └───────────┘  └───────────┘  └───────────┘              │   │ │
    │  │  │                                                             │   │ │
    │  │  └─────────────────────────────────────────────────────────────┘   │ │
    │  │                                                                     │ │
    │  │  PRIVATE DNS ZONES (linked to VNet):                                │ │
    │  │  • privatelink.openai.azure.com                                     │ │
    │  │  • privatelink.search.windows.net                                   │ │
    │  │  • privatelink.documents.azure.com                                  │ │
    │  │  • privatelink.blob.core.windows.net                                │ │
    │  │  • privatelink.vaultcore.azure.net                                  │ │
    │  │  • privatelink.cognitiveservices.azure.com                          │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ Private Link (no public exposure)
                                        ▼
    ┌───────────────────────────────────────────────────────────────────────────┐
    │                         AZURE PAAS SERVICES                               │
    │                      (Public endpoints DISABLED)                          │
    │                                                                           │
    │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                │
    │  │ Azure OpenAI  │  │ Azure AI      │  │ Cosmos DB     │                │
    │  │               │  │ Search        │  │               │                │
    │  └───────────────┘  └───────────────┘  └───────────────┘                │
    │                                                                           │
    │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                │
    │  │ Blob Storage  │  │ Key Vault     │  │ Document      │                │
    │  │               │  │               │  │ Intelligence  │                │
    │  └───────────────┘  └───────────────┘  └───────────────┘                │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Error Handling Flow

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          ERROR HANDLING FLOWCHART                                 │
└──────────────────────────────────────────────────────────────────────────────────┘


                            ┌────────────────────┐
                            │   Incoming Request │
                            └─────────┬──────────┘
                                      │
                                      ▼
                            ┌────────────────────┐
                            │     Validate       │
                            │     Request        │
                            └─────────┬──────────┘
                                      │
                      ┌───────────────┴───────────────┐
                      │                               │
               Valid? │ YES                     NO   │
                      ▼                               ▼
            ┌──────────────────┐           ┌──────────────────┐
            │   Process        │           │   Return 400     │
            │   Request        │           │   Bad Request    │
            └────────┬─────────┘           │                  │
                     │                     │   {              │
                     │                     │     "error": {   │
                     ▼                     │       "code":    │
            ┌──────────────────┐           │       "VALIDATION│
            │   Call External  │           │        _ERROR"   │
            │   Service        │           │     }            │
            └────────┬─────────┘           │   }              │
                     │                     └──────────────────┘
         ┌───────────┴───────────┐
         │                       │
  Success│                  Fail │
         ▼                       ▼
┌──────────────────┐   ┌──────────────────┐
│   Continue       │   │   Check Error    │
│   Processing     │   │   Type           │
└────────┬─────────┘   └────────┬─────────┘
         │                      │
         │              ┌───────┴───────┬───────────────┐
         │              │               │               │
         │        Timeout│         Rate │         Other │
         │              ▼          Limit▼               ▼
         │     ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
         │     │   Retry?     │ │   Retry?     │ │   Retryable? │
         │     │   (attempt < │ │   (after     │ │              │
         │     │    3)        │ │    delay)    │ │              │
         │     └──────┬───────┘ └──────┬───────┘ └──────┬───────┘
         │            │                │                │
         │     ┌──────┴──────┐  ┌──────┴──────┐  ┌──────┴──────┐
         │     │YES      NO  │  │YES      NO  │  │YES      NO  │
         │     ▼             ▼  ▼             ▼  ▼             ▼
         │  ┌──────┐    ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐
         │  │Retry │    │Return│ │Wait+ │ │Return│ │Retry │ │Return│
         │  │with  │    │ 504  │ │Retry │ │ 429  │ │      │ │ 500  │
         │  │backoff    │      │ │      │ │      │ │      │ │      │
         │  └──┬───┘    └──────┘ └──┬───┘ └──────┘ └──┬───┘ └──────┘
         │     │                    │                 │
         │     └────────────────────┴─────────────────┘
         │                          │
         │            ┌─────────────┘
         │            │
         ▼            ▼
┌──────────────────────────────────────────────┐
│              Format Response                  │
└──────────────────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
   Success│                 Error│
         ▼                       ▼
┌──────────────────┐   ┌──────────────────┐
│   Return 200     │   │   Return Error   │
│                  │   │   Code           │
│   {              │   │                  │
│     "data": ...  │   │   + Log Error    │
│   }              │   │   + Alert (if    │
│                  │   │     critical)    │
└──────────────────┘   └──────────────────┘
```

---

## 8. Deployment Pipeline

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                          CI/CD DEPLOYMENT PIPELINE                                │
└──────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                              BUILD STAGE                                         │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │  Developer   │
    │  Push Code   │
    └──────┬───────┘
           │
           │ git push
           ▼
    ┌──────────────┐
    │   GitHub     │
    │   Trigger    │
    └──────┬───────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │                          PARALLEL BUILD JOBS                             │
    │                                                                          │
    │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐           │
    │   │   Frontend     │  │   Backend      │  │   Terraform    │           │
    │   │   Build        │  │   Build        │  │   Validate     │           │
    │   │                │  │                │  │                │           │
    │   │   npm install  │  │   pip install  │  │   tf init      │           │
    │   │   npm build    │  │   pytest       │  │   tf validate  │           │
    │   │   npm test     │  │   pylint       │  │   tf plan      │           │
    │   └────────┬───────┘  └────────┬───────┘  └────────┬───────┘           │
    │            │                   │                   │                    │
    │            └───────────────────┴───────────────────┘                    │
    │                                │                                        │
    │                                ▼                                        │
    │                    ┌────────────────────┐                               │
    │                    │   All Tests Pass?  │                               │
    │                    └────────────────────┘                               │
    │                         │         │                                     │
    │                    YES  │         │ NO                                  │
    │                         ▼         ▼                                     │
    │              ┌──────────────┐ ┌──────────────┐                          │
    │              │   Package    │ │   Fail Build │                          │
    │              │   Artifacts  │ │   Notify Dev │                          │
    │              └──────────────┘ └──────────────┘                          │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DEPLOY TO DEV                                       │
└─────────────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │                          DEV DEPLOYMENT                                  │
    │                                                                          │
    │   ┌────────────────┐                                                    │
    │   │   Terraform    │                                                    │
    │   │   Apply (Dev)  │──▶ Deploy Infrastructure Changes                   │
    │   └────────────────┘                                                    │
    │            │                                                            │
    │            ▼                                                            │
    │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐           │
    │   │   Deploy       │  │   Deploy       │  │   Deploy       │           │
    │   │   Functions    │  │   Frontend     │  │   Config       │           │
    │   │                │  │   to VM        │  │   to KeyVault  │           │
    │   │   func deploy  │  │   scp + nginx  │  │   az keyvault  │           │
    │   └────────────────┘  └────────────────┘  └────────────────┘           │
    │            │                                                            │
    │            ▼                                                            │
    │   ┌────────────────┐                                                    │
    │   │   Run E2E      │──▶ Smoke tests against dev environment            │
    │   │   Tests        │                                                    │
    │   └────────────────┘                                                    │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
                               │
                               │ If branch == main
                               ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DEPLOY TO PROD                                      │
└─────────────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │                      PRODUCTION DEPLOYMENT                               │
    │                                                                          │
    │   ┌────────────────┐                                                    │
    │   │   Manual       │                                                    │
    │   │   Approval     │◀── Required for production                         │
    │   │   Gate         │                                                    │
    │   └────────┬───────┘                                                    │
    │            │                                                            │
    │            │ Approved                                                   │
    │            ▼                                                            │
    │   ┌────────────────┐                                                    │
    │   │   Terraform    │                                                    │
    │   │   Apply (Prod) │──▶ Deploy to production                           │
    │   └────────────────┘                                                    │
    │            │                                                            │
    │            ▼                                                            │
    │   ┌────────────────┐                                                    │
    │   │   Blue/Green   │──▶ Gradual traffic shift                          │
    │   │   Deployment   │                                                    │
    │   └────────────────┘                                                    │
    │            │                                                            │
    │            ▼                                                            │
    │   ┌────────────────┐                                                    │
    │   │   Health       │──▶ Monitor for 30 minutes                         │
    │   │   Check        │                                                    │
    │   └────────────────┘                                                    │
    │            │                                                            │
    │     ┌──────┴──────┐                                                     │
    │     │             │                                                     │
    │  Healthy      Unhealthy                                                 │
    │     │             │                                                     │
    │     ▼             ▼                                                     │
    │ ┌─────────┐  ┌─────────┐                                               │
    │ │Complete │  │Rollback │                                               │
    │ │Deploy   │  │         │                                               │
    │ └─────────┘  └─────────┘                                               │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Monitoring & Alerting

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│                       MONITORING & ALERTING ARCHITECTURE                          │
└──────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DATA SOURCES                                        │
│                                                                                 │
│   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   │
│   │  Functions   │   │     VMs      │   │   AI Search  │   │   Cosmos DB  │   │
│   │   Logs       │   │   Metrics    │   │   Metrics    │   │   Metrics    │   │
│   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘   │
│          │                  │                  │                  │           │
│          └──────────────────┴──────────────────┴──────────────────┘           │
│                                      │                                         │
└──────────────────────────────────────┼─────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           AZURE MONITOR                                          │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                     LOG ANALYTICS WORKSPACE                             │  │
│   │                     log-genai-copilot-dev                               │  │
│   │                                                                         │  │
│   │   Kusto Queries:                                                        │  │
│   │   • requests | where resultCode >= 500                                  │  │
│   │   • traces | where severityLevel >= 3                                   │  │
│   │   • customMetrics | where name == "ResponseTime"                        │  │
│   │                                                                         │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                    APPLICATION INSIGHTS                                 │  │
│   │                    appi-genai-copilot-dev                               │  │
│   │                                                                         │  │
│   │   Tracks:                                                               │  │
│   │   • Request rates & latency                                             │  │
│   │   • Dependency calls                                                    │  │
│   │   • Exception details                                                   │  │
│   │   • Custom events & metrics                                             │  │
│   │                                                                         │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                         │
└──────────────────────────────────────┼─────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ALERT RULES                                         │
│                                                                                 │
│   ┌───────────────────────────────────────────────────────────────────────┐    │
│   │  HIGH SEVERITY ALERTS (P1)                                            │    │
│   │  • Error rate > 5% for 5 minutes                                      │    │
│   │  • Availability < 99% for 10 minutes                                  │    │
│   │  • Response time > 10s for 5 minutes                                  │    │
│   │                                                                       │    │
│   │  Action: Page on-call + Email + Teams                                 │    │
│   └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│   ┌───────────────────────────────────────────────────────────────────────┐    │
│   │  MEDIUM SEVERITY ALERTS (P2)                                          │    │
│   │  • Error rate > 1% for 15 minutes                                     │    │
│   │  • Response time > 5s for 10 minutes                                  │    │
│   │  • Cosmos RU consumption > 80%                                        │    │
│   │                                                                       │    │
│   │  Action: Email + Teams                                                │    │
│   └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│   ┌───────────────────────────────────────────────────────────────────────┐    │
│   │  LOW SEVERITY ALERTS (P3)                                             │    │
│   │  • Daily cost exceeds budget threshold                                │    │
│   │  • Certificate expiry < 30 days                                       │    │
│   │  • Unusual traffic patterns                                           │    │
│   │                                                                       │    │
│   │  Action: Email only                                                   │    │
│   └───────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
└──────────────────────────────────────┬─────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ACTION GROUPS                                          │
│                           ag-genai-copilot-dev                                   │
│                                                                                 │
│   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐            │
│   │      EMAIL       │  │      TEAMS       │  │    PAGERDUTY     │            │
│   │                  │  │                  │  │   (optional)     │            │
│   │  team@domain.com │  │  #alerts channel │  │  On-call         │            │
│   └──────────────────┘  └──────────────────┘  └──────────────────┘            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

*Document End*
