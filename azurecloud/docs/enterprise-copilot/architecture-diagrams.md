# Enterprise Copilot - Architecture Diagrams

## 1. High-Level System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              USER CHANNELS                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Microsoft │  │    Web      │  │   Mobile    │  │    API      │             │
│  │    Teams    │  │   Portal    │  │    App      │  │  Clients    │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
└─────────┼────────────────┼────────────────┼────────────────┼────────────────────┘
          │                │                │                │
          └────────────────┴───────┬────────┴────────────────┘
                                   │
┌──────────────────────────────────┼──────────────────────────────────────────────┐
│                         COPILOT STUDIO                                           │
│  ┌───────────────────────────────┴───────────────────────────────────────────┐  │
│  │                        Agent Orchestration                                 │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │  │
│  │  │  Topic   │  │  Intent  │  │  Memory  │  │   Tool   │  │ Response │    │  │
│  │  │ Router   │  │ Classify │  │  Manager │  │ Executor │  │ Formatter│    │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────┬──────────────────────────────────────────────┘
                                   │
┌──────────────────────────────────┼──────────────────────────────────────────────┐
│                         API MANAGEMENT (APIM)                                    │
│  ┌───────────────────────────────┴───────────────────────────────────────────┐  │
│  │  Rate Limiting │ JWT Validation │ Request Routing │ Logging               │  │
│  └───────────────────────────────┬───────────────────────────────────────────┘  │
└──────────────────────────────────┼──────────────────────────────────────────────┘
                                   │
┌──────────────────────────────────┼──────────────────────────────────────────────┐
│                       AZURE AI FOUNDRY                                           │
│  ┌───────────────────────────────┴───────────────────────────────────────────┐  │
│  │                     RAG ORCHESTRATOR                                       │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │  │
│  │  │  Query   │  │ Retrieval│  │ Context  │  │   LLM    │  │  Post-   │    │  │
│  │  │ Rewrite  │  │  Engine  │  │ Assembly │  │ Generate │  │ Process  │    │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└─────────┬───────────────┬───────────────┬───────────────┬───────────────────────┘
          │               │               │               │
┌─────────┴─────────┐ ┌───┴───────────┐ ┌─┴─────────────┐ ┌┴──────────────────────┐
│   Azure OpenAI    │ │ Azure AI      │ │  Cosmos DB    │ │ Azure Key Vault       │
│  ┌─────────────┐  │ │   Search      │ │ ┌───────────┐ │ │ ┌───────────────────┐ │
│  │   GPT-4o    │  │ │ ┌───────────┐ │ │ │ Sessions  │ │ │ │ API Keys          │ │
│  │  (Generate) │  │ │ │  Vector   │ │ │ └───────────┘ │ │ │ Connection Strings│ │
│  └─────────────┘  │ │ │   Index   │ │ │ ┌───────────┐ │ │ │ Certificates      │ │
│  ┌─────────────┐  │ │ └───────────┘ │ │ │ Ans Cache │ │ │ └───────────────────┘ │
│  │ Embeddings  │  │ │ ┌───────────┐ │ │ └───────────┘ │ └───────────────────────┘
│  │ (text-emb-3)│  │ │ │ Semantic  │ │ │ ┌───────────┐ │
│  └─────────────┘  │ │ │  Ranker   │ │ │ │ Feedback  │ │
└───────────────────┘ │ └───────────┘ │ │ └───────────┘ │
                      └───────────────┘ └───────────────┘
```

---

## 2. Data Ingestion Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DATA SOURCES                                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │SharePoint│  │Confluence│  │  Blob    │  │   Git    │  │  Email   │          │
│  │ Online   │  │  Wiki    │  │ Storage  │  │  Repos   │  │ Archives │          │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘          │
└───────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────────┘
        │             │             │             │             │
        └─────────────┴──────┬──────┴─────────────┴─────────────┘
                             │
┌────────────────────────────┼────────────────────────────────────────────────────┐
│                    EVENT GRID / TRIGGERS                                         │
│                             │                                                    │
│  ┌──────────────────────────┴──────────────────────────────────────────────┐    │
│  │  Schedule Trigger │ Blob Event │ Webhook │ Manual Trigger                │    │
│  └──────────────────────────┬──────────────────────────────────────────────┘    │
└─────────────────────────────┼───────────────────────────────────────────────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────────────────────┐
│                    AZURE DURABLE FUNCTIONS                                       │
│  ┌──────────────────────────┴──────────────────────────────────────────────┐    │
│  │                        INGESTION ORCHESTRATOR                            │    │
│  │                                                                          │    │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐          │    │
│  │  │ Download │───►│  Parse   │───►│  Chunk   │───►│  Embed   │          │    │
│  │  │ Document │    │ (OCR/DI) │    │  Text    │    │ Vectors  │          │    │
│  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘          │    │
│  │                                                        │                │    │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐        │                │    │
│  │  │ Update   │◄───│ Validate │◄───│  Index   │◄───────┘                │    │
│  │  │ Metadata │    │  Result  │    │ AI Search│                          │    │
│  │  └──────────┘    └──────────┘    └──────────┘                          │    │
│  └──────────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────┴───────┐     ┌───────┴───────┐     ┌───────┴───────┐
│ Azure Blob    │     │ Azure AI      │     │ Azure SQL     │
│ (Raw/Gold)    │     │ Search Index  │     │ (Metadata)    │
└───────────────┘     └───────────────┘     └───────────────┘
```

---

## 3. Request Flow Sequence

```
User                Copilot Studio      APIM           RAG Orchestrator    AI Search       Azure OpenAI
  │                      │                │                   │                │                │
  │  1. "What is PTO?"   │                │                   │                │                │
  │─────────────────────►│                │                   │                │                │
  │                      │                │                   │                │                │
  │                      │ 2. Extract user│                   │                │                │
  │                      │    context     │                   │                │                │
  │                      │────────────────►                   │                │                │
  │                      │                │                   │                │                │
  │                      │                │ 3. Validate JWT   │                │                │
  │                      │                │    Rate limit     │                │                │
  │                      │                │    Add headers    │                │                │
  │                      │                │───────────────────►                │                │
  │                      │                │                   │                │                │
  │                      │                │                   │ 4. Classify    │                │
  │                      │                │                   │    intent      │                │
  │                      │                │                   │────────────────────────────────►│
  │                      │                │                   │                │                │
  │                      │                │                   │◄───────────────────────────────│
  │                      │                │                   │    intent: qa  │                │
  │                      │                │                   │                │                │
  │                      │                │                   │ 5. Rewrite     │                │
  │                      │                │                   │    query       │                │
  │                      │                │                   │────────────────────────────────►│
  │                      │                │                   │                │                │
  │                      │                │                   │◄───────────────────────────────│
  │                      │                │                   │ "PTO vacation  │                │
  │                      │                │                   │  policy..."    │                │
  │                      │                │                   │                │                │
  │                      │                │                   │ 6. Generate    │                │
  │                      │                │                   │    embedding   │                │
  │                      │                │                   │────────────────────────────────►│
  │                      │                │                   │                │                │
  │                      │                │                   │◄───────────────────────────────│
  │                      │                │                   │    [0.1, 0.2...]               │
  │                      │                │                   │                │                │
  │                      │                │                   │ 7. Hybrid      │                │
  │                      │                │                   │    search      │                │
  │                      │                │                   │───────────────►│                │
  │                      │                │                   │                │                │
  │                      │                │                   │◄──────────────│                │
  │                      │                │                   │  Top-k chunks  │                │
  │                      │                │                   │  + scores      │                │
  │                      │                │                   │                │                │
  │                      │                │                   │ 8. Assemble    │                │
  │                      │                │                   │    context     │                │
  │                      │                │                   │                │                │
  │                      │                │                   │ 9. Generate    │                │
  │                      │                │                   │    response    │                │
  │                      │                │                   │────────────────────────────────►│
  │                      │                │                   │                │                │
  │                      │                │                   │◄───────────────────────────────│
  │                      │                │                   │    Answer +    │                │
  │                      │                │                   │    citations   │                │
  │                      │                │                   │                │                │
  │                      │                │                   │ 10. Post-      │                │
  │                      │                │                   │     process    │                │
  │                      │                │◄──────────────────│                │                │
  │                      │◄───────────────│                   │                │                │
  │◄─────────────────────│                │                   │                │                │
  │                      │                │                   │                │                │
  │  "Full-time employees receive 20     │                   │                │                │
  │   days PTO annually..."              │                   │                │                │
  │                      │                │                   │                │                │
```

---

## 4. Security Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              INTERNET                                            │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
                         ┌──────────┴──────────┐
                         │   Azure Front Door   │
                         │   (WAF + CDN)        │
                         └──────────┬──────────┘
                                    │
┌───────────────────────────────────┼─────────────────────────────────────────────┐
│                         ENTERPRISE VNET                                          │
│                                   │                                              │
│  ┌────────────────────────────────┼────────────────────────────────────────┐    │
│  │                    INTEGRATION SUBNET                                    │    │
│  │   ┌──────────────┐        ┌────┴───────────┐                            │    │
│  │   │    Entra ID  │        │      APIM      │                            │    │
│  │   │  (Auth/SSO)  │◄──────►│  (Internal)    │                            │    │
│  │   └──────────────┘        └────────────────┘                            │    │
│  └─────────────────────────────────┬───────────────────────────────────────┘    │
│                                    │                                             │
│  ┌─────────────────────────────────┼───────────────────────────────────────┐    │
│  │                      APP SUBNET                                          │    │
│  │   ┌──────────────┐        ┌─────┴──────────┐                            │    │
│  │   │   Copilot    │        │  RAG Service   │                            │    │
│  │   │   Studio     │◄──────►│  (AKS/Func)    │                            │    │
│  │   └──────────────┘        └────────────────┘                            │    │
│  └─────────────────────────────────┬───────────────────────────────────────┘    │
│                                    │                                             │
│                    ┌───────────────┼───────────────┐                            │
│                    │               │               │                            │
│  ┌─────────────────┴───────────────┴───────────────┴───────────────────────┐    │
│  │                         AI SUBNET                                        │    │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │    │
│  │   │ Azure OpenAI │  │  AI Search   │  │  AI Doc      │                  │    │
│  │   │ (Private EP) │  │ (Private EP) │  │  Intelligence│                  │    │
│  │   └──────────────┘  └──────────────┘  └──────────────┘                  │    │
│  └──────────────────────────────────────────────────────────────────────────┘    │
│                                    │                                             │
│  ┌─────────────────────────────────┴───────────────────────────────────────┐    │
│  │                         DATA SUBNET                                      │    │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │    │
│  │   │  Cosmos DB   │  │  Azure SQL   │  │    ADLS      │                  │    │
│  │   │ (Private EP) │  │ (Private EP) │  │ (Private EP) │                  │    │
│  │   └──────────────┘  └──────────────┘  └──────────────┘                  │    │
│  └──────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐    │
│  │                         SECURITY SUBNET                                  │    │
│  │   ┌──────────────┐  ┌──────────────┐                                    │    │
│  │   │  Key Vault   │  │  Log        │                                    │    │
│  │   │ (Private EP) │  │  Analytics  │                                    │    │
│  │   └──────────────┘  └──────────────┘                                    │    │
│  └──────────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────────┐
│                              PRIVATE DNS ZONES                                    │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐         │
│  │privatelink.openai  │  │privatelink.search  │  │privatelink.cosmos  │         │
│  │  .azure.com        │  │  .windows.net      │  │  .azure.com        │         │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘         │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. RBAC Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              USER REQUEST                                        │
│  User: john.doe@company.com                                                     │
│  Groups: [HR-Team, All-Employees, US-Region]                                    │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ENTRA ID                                            │
│  1. Authenticate user                                                           │
│  2. Issue JWT with claims:                                                      │
│     - oid: "abc123"                                                             │
│     - name: "John Doe"                                                          │
│     - groups: ["HR-Team", "All-Employees", "US-Region"]                         │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              APIM                                                │
│  1. Validate JWT signature                                                      │
│  2. Extract groups claim                                                        │
│  3. Set headers: X-User-Id, X-User-Groups                                       │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           RAG ORCHESTRATOR                                       │
│  1. Parse user groups from header                                               │
│  2. Build ACL filter expression:                                                │
│     acl_groups/any(g: search.in(g, 'HR-Team,All-Employees,US-Region'))         │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           AI SEARCH QUERY                                        │
│  {                                                                              │
│    "search": "vacation policy",                                                 │
│    "vectorQueries": [...],                                                      │
│    "filter": "acl_groups/any(g: search.in(g, 'HR-Team,All-Employees'))",       │
│    "select": "chunk_text, title, heading_path"                                  │
│  }                                                                              │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           FILTERED RESULTS                                       │
│  ✓ HR Policy Manual (acl: All-Employees) ──────────────────► INCLUDED          │
│  ✓ PTO Guidelines (acl: HR-Team) ──────────────────────────► INCLUDED          │
│  ✗ Executive Comp Report (acl: Executives) ────────────────► EXCLUDED          │
│  ✗ Board Minutes (acl: Board-Members) ─────────────────────► EXCLUDED          │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Monitoring & Observability

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION COMPONENTS                                 │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐                │
│  │  Copilot   │  │    APIM    │  │    RAG     │  │    AKS     │                │
│  │  Studio    │  │            │  │ Orchestrator│  │  Cluster   │                │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘                │
└────────┼───────────────┼───────────────┼───────────────┼────────────────────────┘
         │               │               │               │
         │    Logs/Traces/Metrics        │               │
         └───────────────┴───────┬───────┴───────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        AZURE MONITOR                                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                     APPLICATION INSIGHTS                                 │    │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐               │    │
│  │   │  Traces  │  │  Metrics │  │   Logs   │  │ Live     │               │    │
│  │   │ (E2E)    │  │(Counters)│  │(Queries) │  │ Metrics  │               │    │
│  │   └──────────┘  └──────────┘  └──────────┘  └──────────┘               │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                     LOG ANALYTICS WORKSPACE                              │    │
│  │   ┌────────────────────────────────────────────────────────────────┐    │    │
│  │   │  Query: requests | where success == false | summarize count()  │    │    │
│  │   └────────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
         ┌──────────────────────────┼──────────────────────────┐
         │                          │                          │
         ▼                          ▼                          ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    DASHBOARDS   │    │     ALERTS      │    │    WORKBOOKS    │
│  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │
│  │ Latency   │  │    │  │ Error Rate│  │    │  │ Weekly    │  │
│  │ P50/P95   │  │    │  │ > 5%      │  │    │  │ Report    │  │
│  ├───────────┤  │    │  ├───────────┤  │    │  ├───────────┤  │
│  │ Cache Hit │  │    │  │ Latency   │  │    │  │ Cost      │  │
│  │ Rate      │  │    │  │ P95 > 3s  │  │    │  │ Analysis  │  │
│  ├───────────┤  │    │  ├───────────┤  │    │  ├───────────┤  │
│  │ Tokens/   │  │    │  │ Rate Limit│  │    │  │ Usage     │  │
│  │ Query     │  │    │  │ Exceeded  │  │    │  │ Trends    │  │
│  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

## 7. Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           SOURCE CONTROL                                         │
│                         (Azure DevOps / GitHub)                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐                                │
│  │   /src     │  │ /infra     │  │  /tests    │                                │
│  │ (App Code) │  │(Terraform) │  │(Pytest)    │                                │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘                                │
└────────┼───────────────┼───────────────┼────────────────────────────────────────┘
         │               │               │
         └───────────────┴───────┬───────┘
                                 │ Git Push / PR
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           CI/CD PIPELINE                                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │  Build  │─►│  Test   │─►│Security │─►│  Eval   │─►│ Deploy  │─►│ Monitor │ │
│  │         │  │(Unit)   │  │  Scan   │  │  Gate   │  │(Staged) │  │         │ │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘ │
└───────────────────────────────────────────────┬─────────────────────────────────┘
                                                │
         ┌──────────────────────────────────────┼──────────────────────────────┐
         │                                      │                              │
         ▼                                      ▼                              ▼
┌─────────────────┐              ┌─────────────────┐              ┌─────────────────┐
│      DEV        │              │    STAGING      │              │   PRODUCTION    │
│  ┌───────────┐  │              │  ┌───────────┐  │              │  ┌───────────┐  │
│  │ Resource  │  │              │  │ Resource  │  │              │  │ Resource  │  │
│  │ Group DEV │  │              │  │Group STAGE│  │              │  │Group PROD │  │
│  └───────────┘  │              │  └───────────┘  │              │  └───────────┘  │
│  ┌───────────┐  │              │  ┌───────────┐  │              │  ┌───────────┐  │
│  │  AI Search│  │              │  │  AI Search│  │              │  │  AI Search│  │
│  │  (Basic)  │  │              │  │ (Standard)│  │              │  │ (Standard)│  │
│  └───────────┘  │              │  └───────────┘  │              │  └───────────┘  │
│  ┌───────────┐  │              │  ┌───────────┐  │              │  ┌───────────┐  │
│  │Azure OpenAI│ │              │  │Azure OpenAI│ │              │  │Azure OpenAI│ │
│  │  (Shared) │  │              │  │  (Shared) │  │              │  │(Dedicated)│  │
│  └───────────┘  │              │  └───────────┘  │              │  └───────────┘  │
│                 │              │                 │              │                 │
│ Auto-deploy on  │              │ Deploy on PR    │              │ Manual approve  │
│ commit to dev   │              │ merge to main   │              │ + shadow test   │
└─────────────────┘              └─────────────────┘              └─────────────────┘
```

---

*Document Version: 1.0*
*Last Updated: 2025-01-15*
